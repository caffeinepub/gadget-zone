{
  "kind": "build_request",
  "title": "Install GA4 (gtag.js) in <head> with enhanced measurement and custom click/scroll events",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Add Google Analytics 4 (GA4) base tracking code (gtag.js) to the <head> so it loads on all pages, using the Measurement ID provided via configuration (do not hardcode the ID).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "1) Add GA4 tracking code in the <head> section of all pages.\nI will provide my Measurement ID separately."
        ]
      },
      "acceptanceCriteria": [
        "GA4 script is loaded from the document <head> (not injected into <body>).",
        "Measurement ID is sourced from configuration (e.g., existing VITE_GA_MEASUREMENT_ID flow) and is not hardcoded in the repo.",
        "Tracking initialization remains idempotent (no duplicate script tags / no duplicate config calls on re-renders)."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure GA4 Enhanced Measurement is supported for: page views, scroll tracking, outbound clicks, and site search (when available). Do not disable enhanced measurement in code.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "2) Enable Enhanced Measurement:\n- Page views\n- Scroll tracking\n- Outbound clicks\n- Site search (if available)"
        ]
      },
      "acceptanceCriteria": [
        "The GA4 configuration does not set flags that would disable enhanced measurement features (e.g., no code disables page_view collection or link/scroll measurement).",
        "A page_view is sent on initial load (and on subsequent SPA route changes if the app uses history navigation).",
        "Outbound link clicks are tracked either via GA4 enhanced measurement (preferred) or via a safe fallback handler that only fires when GA is enabled."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Track any click on a WhatsApp button/link as a custom GA4 event with event name \"whatsapp_click\" and include the current page URL as an event parameter.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "3) Track WhatsApp button clicks as a custom event:\nEvent name: whatsapp_click\nTrigger: Any click on WhatsApp button or WhatsApp link\nPass page URL as parameter."
        ]
      },
      "acceptanceCriteria": [
        "Clicking any WhatsApp link (e.g., https://wa.me/* links, including those rendered by the WhatsApp quick-message popover and the highlights strip) triggers a single GA4 event named \"whatsapp_click\".",
        "The event includes a parameter containing the current page URL (e.g., page_url: window.location.href).",
        "No runtime errors occur when GA is not configured/enabled (event calls are safely no-op)."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Track any click on telephone links (tel:) as a custom GA4 event with event name \"call_click\" and include the current page URL as an event parameter.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "4) Track Call button clicks as a custom event:\nEvent name: call_click\nTrigger: Any click on tel: links\nPass page URL as parameter."
        ]
      },
      "acceptanceCriteria": [
        "Clicking any <a href=\"tel:...\"> link triggers a single GA4 event named \"call_click\".",
        "The event includes a parameter containing the current page URL (e.g., page_url: window.location.href).",
        "No runtime errors occur when GA is not configured/enabled (event calls are safely no-op)."
      ]
    },
    {
      "id": "REQ-5",
      "text": "Track scroll depth at 25%, 50%, 75%, and 100% as a custom GA4 event with event name \"scroll_depth\" and include the depth percentage and current page URL as parameters.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "5) Track scroll depth (25%, 50%, 75%, 100%)\nEvent name: scroll_depth"
        ]
      },
      "acceptanceCriteria": [
        "As the user scrolls, events fire at 25/50/75/100% thresholds at most once per threshold per page load.",
        "Each event uses name \"scroll_depth\" and includes parameters for depth (25/50/75/100) and the current page URL.",
        "Scroll listener is implemented in a performance-safe way (throttled/optimized and using passive listeners)."
      ]
    },
    {
      "id": "REQ-6",
      "text": "Ensure UTM parameters (traffic source/medium/campaign) are properly captured by GA4 without being overwritten by custom code.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "6) Ensure traffic source, medium, and campaign parameters (UTM) are properly captured."
        ]
      },
      "acceptanceCriteria": [
        "GA4 configuration preserves default campaign attribution behavior (no custom config overwrites source/medium/campaign fields).",
        "When the page is loaded with utm_source/utm_medium/utm_campaign in the URL, GA4 receives the page_location containing those parameters."
      ]
    },
    {
      "id": "REQ-7",
      "text": "Implement all analytics additions without modifying layout/styling and without noticeable performance regressions.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "7) Make sure this does NOT affect website design or performance.\n\nDo not modify layout or styling.\nOnly add analytics tracking scripts cleanly."
        ]
      },
      "acceptanceCriteria": [
        "No CSS/Tailwind class changes are required to implement tracking.",
        "All added scripts are async/deferred and do not block initial render.",
        "All tracking code paths are guarded so the site behaves identically when tracking IDs are not configured."
      ]
    }
  ],
  "constraints": [
    "Do not modify layout or styling; only add analytics tracking scripts/handlers.",
    "Frontend immutable paths must not be edited: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui/*.",
    "Backend remains a single Motoko actor; no additional backend services/databases."
  ],
  "nonGoals": [
    "Setting GA4 Enhanced Measurement toggles in the Google Analytics UI (this build only covers on-site implementation and does not include GA property admin changes).",
    "Adding any non-Google analytics vendors or third-party authentication."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}